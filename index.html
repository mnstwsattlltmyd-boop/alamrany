<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المتجر - سلة</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">إدارة المتجر</div>
            <nav>
                <ul>
                    <li class="active"><a href="index.html">الرئيسية</a></li>
                    <li><a href="orders.html">الطلبات</a></li>
                    <li><a href="products.html">المنتجات</a></li>
                    <li><a href="reports.html">التقارير</a></li>
                    <li><a href="marketing.html">التسويق</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h2>أهلاً بك، لوحة التحكم الرئيسية</h2>
                <div class="user-profile">
                    <span>مدير المتجر</span>
                </div>
            </header>

            <section class="summary-section">
                <div class="month-summary-card">
                    <h3>ملخص الشهر (مارس 2023)</h3>
                    <div class="chart-placeholder" id="monthly-sales-chart"></div>
                </div>

                <div class="stats-cards-container" id="dashboard-stats">
                    <div class="stat-card">
                        <span class="stat-value" id="stat-sales">1,546</span>
                        <span class="stat-label">المبيعات (رس)</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="stat-visits">546</span>
                        <span class="stat-label">عدد الزيارات</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="stat-orders">32</span>
                        <span class="stat-label">الطلبات</span>
                    </div>
                    <div class="stat-card goal-card">
                        <span class="stat-value" id="stat-goal">546</span>
                        <span class="stat-label">هدف الشهر</span>
                    </div>
                </div>
            </section>

            <section class="latest-orders-section">
                <h3>أحدث الطلبات</h3>
                <div class="order-list-placeholder" id="latest-orders-list">
                    <p>جاري تحميل أحدث الطلبات...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> 

    <script>
        // ⚠️ مهم: يجب استبدال هذا بكود التهيئة الفعلي لمشروعك "osama-alqisee"
        const firebaseConfig = {
            apiKey: "AIzaSyBNQ7YzUxzveUorMgHraMii7C5uZ-K8b6s",
            authDomain: "osama-alqisee.firebaseapp.com",
            projectId: "osama-alqisee",
            storageBucket: "osama-alqisee.firebasestorage.app",
            messagingSenderId: "689498064354",
            appId: "1:689498064354:web:956a072dd4e9ee99f2e5bb",
            measurementId: "G-F8GL8K46W5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.analytics();
    </script>

    <script>
        // الدالة لجلب إحصائيات لوحة التحكم وعرضها
        async function fetchDashboardStats() {
            try {
                // جلب الإحصائيات من مستند واحد (نفترض اسمه 'dashboard_kpis' في مجموعة 'reports')
                const doc = await db.collection("reports").doc("dashboard_kpis").get();
                
                if (doc.exists) {
                    const stats = doc.data();
                    
                    // تحديث بطاقات الإحصائيات
                    document.getElementById('stat-sales').textContent = stats.sales ? stats.sales.toLocaleString() : '0';
                    document.getElementById('stat-visits').textContent = stats.visits ? stats.visits.toLocaleString() : '0';
                    document.getElementById('stat-orders').textContent = stats.orders ? stats.orders.toLocaleString() : '0';
                    document.getElementById('stat-goal').textContent = stats.monthlyGoal ? stats.monthlyGoal.toLocaleString() : '0';
                } else {
                    console.warn("لم يتم العثور على مستند الإحصائيات (dashboard_kpis). سيتم استخدام القيم الافتراضية.");
                }
                
                // جلب أحدث الطلبات
                fetchLatestOrders();

            } catch (error) {
                console.error("❌ خطأ في جلب بيانات لوحة التحكم:", error);
            }
        }
        
        // الدالة لجلب أحدث 5 طلبات
        async function fetchLatestOrders() {
            const listContainer = document.getElementById('latest-orders-list');
            listContainer.innerHTML = '<p>جاري تحميل أحدث الطلبات...</p>'; 
            
            try {
                // جلب آخر 5 طلبات
                const snapshot = await db.collection("orders")
                                         .orderBy("createdAt", "desc")
                                         .limit(5)
                                         .get();
                
                listContainer.innerHTML = ''; // مسح رسالة التحميل
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p>لا توجد طلبات جديدة.</p>';
                    return;
                }
                
                const ul = document.createElement('ul');
                ul.className = 'latest-orders-list-ul';
                
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderIdShort = doc.id.substring(0, 8);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>طلب #${orderIdShort}</span>
                        <span>${(order.totalAmount || 0).toFixed(2)} رس</span>
                        <span class="order-status ${order.status || 'default'}">${order.statusText || 'غير محدد'}</span>
                    `;
                    ul.appendChild(li);
                });
                
                listContainer.appendChild(ul);

            } catch (error) {
                console.error("❌ خطأ في جلب أحدث الطلبات:", error);
                listContainer.innerHTML = '<p style="color:red;">فشل في تحميل الطلبات. (تحقق من مجموعة Orders)</p>';
            }
        }
        
        // تشغيل الوظيفة عند تحميل الصفحة
        fetchDashboardStats();
    </script>
</body>
</html>
