<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</div>
            <nav>
                <ul>
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="active"><a href="orders.html">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a></li>
                    <li><a href="products.html">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
                    <li><a href="reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                    <li><a href="marketing.html">Ø§Ù„ØªØ³ÙˆÙŠÙ‚</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
            </header>

            <section class="orders-filter-status">
                <div class="status-tabs" id="status-tabs-container">
                    <span class="status-tab active-status" data-status="all">Ø§Ù„ÙƒÙ„ (0)</span>
                    <span class="status-tab" data-status="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (0)</span>
                    <span class="status-tab" data-status="processing">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (0)</span>
                    <span class="status-tab" data-status="shipped">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù† (0)</span>
                    <span class="status-tab" data-status="completed">Ù…ÙƒØªÙ…Ù„Ø© (0)</span>
                </div>
                <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." class="search-orders-input">
            </section>

            <section class="orders-table-card">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> 

    <script>
        // âš ï¸ Ù…Ù‡Ù…: ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹ "osama-alqisee"
        const firebaseConfig = {
            apiKey: "AIzaSyBNQ7YzUxzveUorMgHraMii7C5uZ-KK8b6s",
            authDomain: "osama-alqisee.firebaseapp.com",
            projectId: "osama-alqisee",
            storageBucket: "osama-alqisee.firebasestorage.app",
            messagingSenderId: "689498064354",
            appId: "1:689498064354:web:956a072dd4e9ee99f2e5bb",
            measurementId: "G-F8GL8K46W5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.analytics();
        
        // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø¨)
        let allOrdersData = [];
    </script>

    <script>
        const ordersTableBody = document.getElementById('orders-table-body');
        const statusTabs = document.querySelectorAll('.status-tab');
        
        // ------------------------------------------------------------------
        // * ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        // ------------------------------------------------------------------

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¨Ù†Ø§Ø¡ ØµÙ Ø§Ù„Ø·Ù„Ø¨
        function buildOrderRow(orderData, orderId) {
            const row = document.createElement('tr');
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            let statusText = orderData.statusText || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            let statusClass = 'default-badge';
            
            if (orderData.status === 'pending') statusClass = 'pending-badge';
            else if (orderData.status === 'processing') statusClass = 'processing-badge';
            else if (orderData.status === 'shipped') statusClass = 'shipped-badge';
            else if (orderData.status === 'completed') statusClass = 'completed-badge';
            
            const orderDate = orderData.createdAt 
                ? orderData.createdAt.toDate().toLocaleDateString('ar-EG') 
                : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

            row.setAttribute('data-status', orderData.status);
            
            row.innerHTML = `
                <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨">#${orderId.substring(0, 5).toUpperCase()}</td>
                <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„">${orderData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„'}</td>
                <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº">${(orderData.totalAmount || 0).toFixed(2)} Ø±Ø³</td>
                <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${orderDate}</td>
                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">
                    <a href="order_details.html?id=${orderId}" class="action-btn view-btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a> 
                </td>
            `;
            return row;
        }

        // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Firestore
        async function fetchAndRenderOrders() {
            ordersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>';

            try {
                const snapshot = await db.collection("orders").orderBy("createdAt", "desc").get();
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØªÙØ±ÙŠØº Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                ordersTableBody.innerHTML = ''; 
                allOrdersData = [];

                if (snapshot.empty) {
                    ordersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¥Ù„Ù‰ 0
                    updateStatusCounts(0, 0, 0, 0, 0); 
                    return;
                }

                let counts = { all: 0, pending: 0, processing: 0, shipped: 0, completed: 0 };
                
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    const orderId = doc.id;
                    
                    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù„Ø§Ø­Ù‚Ø©
                    allOrdersData.push({ id: orderId, ...orderData });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯
                    counts.all++;
                    if (counts.hasOwnProperty(orderData.status)) {
                        counts[orderData.status]++;
                    }
                    
                    const newRow = buildOrderRow(orderData, orderId);
                    ordersTableBody.appendChild(newRow);
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                updateStatusCounts(counts.all, counts.pending, counts.processing, counts.shipped, counts.completed);

            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Firestore: ", error);
                ordersTableBody.innerHTML = `<tr><td colspan="6" style="color: red; text-align: center;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</td></tr>`;
            }
        }
        
        // ------------------------------------------------------------------
        // * ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        // ------------------------------------------------------------------

        function updateStatusCounts(all, pending, processing, shipped, completed) {
            statusTabs.forEach(tab => {
                const status = tab.getAttribute('data-status');
                let count = 0;
                if (status === 'all') count = all;
                else if (status === 'pending') count = pending;
                else if (status === 'processing') count = processing;
                else if (status === 'shipped') count = shipped;
                else if (status === 'completed') count = completed;

                tab.textContent = `${tab.textContent.split('(')[0].trim()} (${count})`;
            });
        }

        // ------------------------------------------------------------------
        // * ÙˆØ¸ÙŠÙØ© ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹)
        // ------------------------------------------------------------------
        
        // 2. Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø­Ø¯Ø« (Event Listeners) Ù„ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨
        statusTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Ø£. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                statusTabs.forEach(t => t.classList.remove('active-status'));
                this.classList.add('active-status');

                // Ø¨. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ ÙÙ„ØªØ±ØªÙ‡Ø§
                const selectedStatus = this.getAttribute('data-status');
                
                // Ø¬. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„)
                filterOrdersByStatus(selectedStatus);
            });
        });

        // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function filterOrdersByStatus(status) {
            // Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø¬Ù…ÙŠØ¹ ØµÙÙˆÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const orderRows = ordersTableBody.querySelectorAll('tr'); 
            
            orderRows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');

                if (status === 'all' || rowStatus === status) {
                    row.style.display = ''; // Ø¹Ø±Ø¶ Ø§Ù„ØµÙ
                } else {
                    row.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙ
                }
            });
        }

        // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        fetchAndRenderOrders();
    </script>
</body>
</html>
