<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</div>
            <nav>
                <ul>
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="orders.html">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a></li>
                    <li><a href="products.html">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
                    <li class="active"><a href="reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                    <li><a href="marketing.html">Ø§Ù„ØªØ³ÙˆÙŠÙ‚</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h2>ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±</h2>
            </header>

            <section class="controls-bar">
                <select id="timeRangeSelector">
                    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                    <option value="last_week">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
                    <option value="last_month" selected>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§</option>
                    <option value="custom">ØªØ­Ø¯ÙŠØ¯ Ù…Ø®ØµØµ</option>
                </select>
                <input type="date" id="startDate" class="date-input">
                <input type="date" id="endDate" class="date-input">
                <button class="filter-btn">ØªØ·Ø¨ÙŠÙ‚</button>
            </section>
            
            <section class="kpi-cards-container">
                <div class="kpi-card revenue">
                    <span class="kpi-value" id="kpi-revenue">5,890.00 Ø±Ø³</span>
                    <span class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
                    <span class="kpi-change up" id="kpi-revenue-change">â†‘ 15%</span>
                </div>
                <div class="kpi-card orders">
                    <span class="kpi-value" id="kpi-orders">124</span>
                    <span class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                    <span class="kpi-change down" id="kpi-orders-change">â†“ 5%</span>
                </div>
                <div class="kpi-card visitors">
                    <span class="kpi-value" id="kpi-visitors">2,100</span>
                    <span class="kpi-label">Ø§Ù„Ø²ÙˆØ§Ø±</span>
                    <span class="kpi-change up" id="kpi-visitors-change">â†‘ 22%</span>
                </div>
                <div class="kpi-card conversion">
                    <span class="kpi-value" id="kpi-conversion">5.9%</span>
                    <span class="kpi-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>
                    <span class="kpi-change up" id="kpi-conversion-change">â†‘ 0.5 Ù†Ù‚Ø·Ø©</span>
                </div>
            </section>

            <section class="charts-section">
                <div class="main-chart-card">
                    <h3>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù…</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="side-report-card">
                    <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                    <ul class="top-selling-list" id="top-selling-list">
                        <li><p style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> 

    <script>
        // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ "osama-alqisee"
        const firebaseConfig = {
            apiKey: "AIzaSyBNQ7YzUxzveUorMgHraMii7C5uZ-K8b6s",
            authDomain: "osama-alqisee.firebaseapp.com",
            projectId: "osama-alqisee",
            storageBucket: "osama-alqisee.firebasestorage.app",
            messagingSenderId: "689498064354",
            appId: "1:689498064354:web:956a072dd4e9ee99f2e5bb",
            measurementId: "G-F8GL8K46W5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.analytics();
        
        // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„ØªØ®Ø²ÙŠÙ† Ù†Ø³Ø®Ø© Ù…Ù† ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        let revenueChart = null; 
    </script>

    <script>
        const topSellingList = document.getElementById('top-selling-list');
        const kpiElements = {
            revenue: document.getElementById('kpi-revenue'),
            orders: document.getElementById('kpi-orders'),
            visitors: document.getElementById('kpi-visitors'),
            conversion: document.getElementById('kpi-conversion'),
            revenueChange: document.getElementById('kpi-revenue-change'),
            ordersChange: document.getElementById('kpi-orders-change'),
            visitorsChange: document.getElementById('kpi-visitors-change'),
            conversionChange: document.getElementById('kpi-conversion-change'),
        };

        // ********************************************************
        // 1. ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
        // ********************************************************

        async function fetchReportData() {
            try {
                // Ø§ÙØªØ±Ø§Ø¶: Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù† Ù…Ø³ØªÙ†Ø¯ ØªÙ‚Ø±ÙŠØ± (Report Document)
                const kpiDoc = await db.collection("reports").doc("monthly_summary").get();
                if (kpiDoc.exists) {
                    const data = kpiDoc.data();
                    updateKPIs(data);
                } else {
                    console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©.");
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
                }
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
                const chartAndProductsDoc = await db.collection("reports").doc("sales_performance").get();
                if (chartAndProductsDoc.exists) {
                    const data = chartAndProductsDoc.data();
                    renderRevenueChart(data.chartData || { labels: [], data: [] });
                    renderTopSellingProducts(data.topProducts || []);
                } else {
                    renderRevenueChart({ labels: [], data: [] });
                    renderTopSellingProducts([]);
                }
                

            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:", error);
                // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
                document.getElementById('kpi-revenue').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
            }
        }

        // ********************************************************
        // 2. ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ********************************************************
        
        function updateKPIs(data) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            kpiElements.revenue.textContent = (data.revenue || 0).toLocaleString() + ' Ø±Ø³';
            kpiElements.orders.textContent = (data.orders || 0).toLocaleString();
            kpiElements.visitors.textContent = (data.visitors || 0).toLocaleString();
            kpiElements.conversion.textContent = (data.conversion || 0).toFixed(1) + '%';

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØºÙŠØ±Ø§Øª (Change Indicators)
            // (Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ù„ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØºÙŠØ± ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ø§Ø³ up/down)
            
            // Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØºÙŠØ±
            const changeRevenue = data.changeRevenue || 0.15; // 15%
            const changeOrders = data.changeOrders || -0.05; // -5%

            kpiElements.revenueChange.textContent = `${changeRevenue > 0 ? 'â†‘' : 'â†“'} ${Math.abs(changeRevenue * 100).toFixed(0)}%`;
            kpiElements.revenueChange.className = `kpi-change ${changeRevenue > 0 ? 'up' : 'down'}`;

            kpiElements.ordersChange.textContent = `${changeOrders > 0 ? 'â†‘' : 'â†“'} ${Math.abs(changeOrders * 100).toFixed(0)}%`;
            kpiElements.ordersChange.className = `kpi-change ${changeOrders > 0 ? 'up' : 'down'}`;
        }

        function renderRevenueChart(chartDataFromFirestore) {
            const chartData = {
                labels: chartDataFromFirestore.labels,
                datasets: [{
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±Ø³)',
                    data: chartDataFromFirestore.data,
                    backgroundColor: 'rgba(56, 163, 165, 0.2)',
                    borderColor: '#38a3a5',
                    borderWidth: 2,
                    tension: 0.4 
                }]
            };
            
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (revenueChart) {
                revenueChart.destroy();
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'line', 
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { }
                    }
                }
            });
        }
        
        function renderTopSellingProducts(productsArray) {
            topSellingList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
            
            if (productsArray.length === 0) {
                topSellingList.innerHTML = '<li><p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p></li>';
                return;
            }
            
            productsArray.forEach((product, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${index + 1}. ${product.name} <span class="amount">${(product.amount || 0).toLocaleString()} Ø±Ø³</span>`;
                topSellingList.appendChild(li);
            });
        }
        
        // ********************************************************
        // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
        // ********************************************************

        fetchReportData();

        // --------------------------------------------------------
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        // --------------------------------------------------------
        // ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø²Ø± 'ØªØ·Ø¨ÙŠÙ‚' Ùˆ select 'timeRangeSelector' 
        // Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ fetchReportData(timeRange) Ù…Ø¹ Ù†Ø·Ø§Ù‚ Ø²Ù…Ù†ÙŠ Ø¬Ø¯ÙŠØ¯ 
        // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù…Ù† Firestore.
    </script>
</body>
</html>
