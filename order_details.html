<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</div>
            <nav>
                <ul>
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="active"><a href="orders.html">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a></li>
                    <li><a href="products.html">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
                    <li><a href="reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                    <li><a href="marketing.html">Ø§Ù„ØªØ³ÙˆÙŠÙ‚</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h2 id="order-title">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #...</h2> 
                <a href="orders.html" class="back-btn">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª</a>
            </header>

            <div id="loading-area" style="text-align: center; padding: 50px; display: none;">
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨...</p>
            </div>

            <div class="details-layout" id="order-details-content">
                <div class="details-primary-column">
                    
                    <div class="card order-status-header">
                        <div class="status-info">
                            <span class="status-badge" id="order-status-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            <p id="order-date-payment">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: -- | ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø±: --</p>
                        </div>
                        <div class="status-actions">
                            <select id="status-change-select" class="action-select">
                                <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="processing">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
                                <option value="shipped">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†</option>
                                <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                            </select>
                            <button class="action-btn primary-action-btn" id="update-status-btn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                        </div>
                    </div>

                    <div class="card products-ordered-card">
                        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (<span id="products-count">0</span> Ø£ØµÙ†Ø§Ù)</h3>
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody id="products-ordered-body">
                                </tbody>
                        </table>
                        
                        <div class="order-summary-footer">
                            <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: <span id="sub-total">--</span> Ø±Ø³</p>
                            <p>Ø±Ø³ÙˆÙ… Ø§Ù„Ø´Ø­Ù†: <span id="shipping-fee">--</span> Ø±Ø³</p>
                            <h4 class="total-amount">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total-amount">--</span> Ø±Ø³</h4>
                        </div>
                    </div>
                </div>

                <div class="details-secondary-column">
                    
                    <div class="card customer-info-card">
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø´Ø­Ù†</h3>
                        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="customer-name">--</span> (ID: <span id="customer-id">--</span>)</p>
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="customer-phone">--</span></p>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="shipping-address">--</span></p>
                        <p><strong>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†:</strong> <span id="shipping-company">--</span></p>
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> <span id="tracking-number">--</span></p>
                    </div>

                    <div class="card order-timeline-card">
                        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
                        <ul class="timeline" id="order-timeline">
                            </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> 

    <script>
        // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ "osama-alqisee"
        const firebaseConfig = {
            apiKey: "AIzaSyBNQ7YzUxzveUorMgHraMii7C5uZ-K8b6s",
            authDomain: "osama-alqisee.firebaseapp.com",
            projectId: "osama-alqisee",
            storageBucket: "osama-alqisee.firebasestorage.app",
            messagingSenderId: "689498064354",
            appId: "1:689498064354:web:956a072dd4e9ee99f2e5bb",
            measurementId: "G-F8GL8K46W5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.analytics();
        
        let currentOrderId = null; // Ù„ØªØ®Ø²ÙŠÙ† ID Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let currentOrderStatus = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    </script>

    <script>
        const detailsContent = document.getElementById('order-details-content');
        const loadingArea = document.getElementById('loading-area');
        const updateStatusBtn = document.getElementById('update-status-btn');
        const statusSelect = document.getElementById('status-change-select');

        // ********************************************************
        // 1. ÙˆØ¸ÙŠÙØ© Ù‚Ø±Ø§Ø¡Ø© ID Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (URL)
        // ********************************************************

        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø´Ø§Ø¨Ù‡Ø§Ù‹ Ù„Ù€ orders.html?id=DOCUMENT_ID_HERE
            return urlParams.get('id'); 
        }

        // ********************************************************
        // 2. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨ÙˆØ§Ø³Ø·Ø© ID
        // ********************************************************

        async function fetchOrderDetails(orderId) {
            loadingArea.style.display = 'block';
            detailsContent.style.display = 'none';

            if (!orderId) {
                loadingArea.innerHTML = '<p style="color: red;">âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.</p>';
                return;
            }

            try {
                const doc = await db.collection("orders").doc(orderId).get();

                if (!doc.exists) {
                    loadingArea.innerHTML = `<p style="color: red;">âŒ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${orderId.substring(0, 5)} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>`;
                    return;
                }

                const orderData = doc.data();
                currentOrderId = orderId;
                currentOrderStatus = orderData.status;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateUIWithOrderData(orderData, orderId);

            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
                loadingArea.innerHTML = `<p style="color: red;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨: ${error.message}</p>`;
            } finally {
                loadingArea.style.display = 'none';
                detailsContent.style.display = 'grid';
            }
        }
        
        // ********************************************************
        // 3. ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
        // ********************************************************

        function updateUIWithOrderData(data, id) {
            document.getElementById('page-title').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${id.substring(0, 5).toUpperCase()}`;
            document.getElementById('order-title').textContent = `ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #${id.substring(0, 5).toUpperCase()}`;

            // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            const badge = document.getElementById('order-status-badge');
            badge.textContent = data.statusText || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            badge.className = `status-badge ${data.status}-badge`;
            
            document.getElementById('order-date-payment').textContent = 
                `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: ${data.createdAt ? data.createdAt.toDate().toLocaleDateString('ar-EG') : '--'} | ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø±: ${data.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø´Ø­Ù†
            document.getElementById('customer-name').textContent = data.customerName || '--';
            document.getElementById('customer-id').textContent = data.customerId || '--';
            document.getElementById('customer-phone').textContent = data.customerPhone || '--';
            document.getElementById('shipping-address').textContent = data.shippingAddress || '--';
            document.getElementById('shipping-company').textContent = data.shippingCompany || '--';
            document.getElementById('tracking-number').textContent = data.trackingNumber || '--';

            // Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
            document.getElementById('products-count').textContent = data.products.length || 0;
            document.getElementById('sub-total').textContent = (data.subTotal || 0).toFixed(2);
            document.getElementById('shipping-fee').textContent = (data.shippingFee || 0).toFixed(2);
            document.getElementById('total-amount').textContent = (data.totalAmount || 0).toFixed(2);

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const productsBody = document.getElementById('products-ordered-body');
            productsBody.innerHTML = '';
            data.products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${(p.price || 0).toFixed(2)} Ø±Ø³</td>
                    <td>${p.quantity || 1}</td>
                    <td>${((p.price || 0) * (p.quantity || 1)).toFixed(2)} Ø±Ø³</td>
                `;
                productsBody.appendChild(row);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Timeline)
            const timeline = document.getElementById('order-timeline');
            timeline.innerHTML = '';
            if (data.timeline && Array.isArray(data.timeline)) {
                data.timeline.forEach(event => {
                    const li = document.createElement('li');
                    const date = event.timestamp ? event.timestamp.toDate().toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    li.innerHTML = `<span class="timeline-date">${date}</span><p>${event.description}</p>`;
                    timeline.appendChild(li);
                });
            }

            // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            statusSelect.value = data.status;
            // ØªØ¹Ø·ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ
            Array.from(statusSelect.options).forEach(opt => {
                opt.disabled = opt.value === data.status;
            });
        }


        // ********************************************************
        // 4. ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Firebase
        // ********************************************************

        async function updateOrderStatus() {
            if (!currentOrderId) return;
            
            const newStatus = statusSelect.value;
            const newStatusText = statusSelect.options[statusSelect.selectedIndex].text.replace('ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰: ', '');

            if (newStatus === currentOrderStatus) {
                alert("Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‡ÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
                return;
            }

            // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${currentOrderId.substring(0, 5)} Ø¥Ù„Ù‰ "${newStatusText}"ØŸ`)) {
                return;
            }
            
            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«
            const updateData = {
                status: newStatus,
                statusText: newStatusText,
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø²Ù…Ù†ÙŠ Ø¬Ø¯ÙŠØ¯
                timeline: firebase.firestore.FieldValue.arrayUnion({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    description: `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${newStatusText}`
                })
            };

            updateStatusBtn.disabled = true;
            updateStatusBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';

            try {
                await db.collection("orders").doc(currentOrderId).update(updateData);
                
                alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«)
                await fetchOrderDetails(currentOrderId); 

            } catch (error) {
                console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨:", error);
                alert(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${error.message}`);
            } finally {
                updateStatusBtn.disabled = false;
                updateStatusBtn.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©';
            }
        }

        // ********************************************************
        // 5. Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        // ********************************************************

        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù„ÙˆØ¸ÙŠÙØ©
        updateStatusBtn.addEventListener('click', updateOrderStatus);
        
        // ØªØ´ØºÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ù„Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        const id = getOrderIdFromUrl();
        fetchOrderDetails(id);
    </script>
</body>
</html>
