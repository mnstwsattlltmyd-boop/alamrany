<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المنتجات</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">إدارة المتجر</div>
            <nav>
                <ul>
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="orders.html">الطلبات</a></li>
                    <li class="active"><a href="products.html">المنتجات</a></li>
                    <li><a href="reports.html">التقارير</a></li>
                    <li><a href="marketing.html">التسويق</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h2>إدارة المنتجات</h2>
                <button class="add-product-btn">+ منتج جديد</button>
            </header>

            <section class="filter-bar">
                <input type="text" id="product-search" placeholder="ابحث عن منتج...">
                <select id="product-type-filter">
                    <option value="all">جميع المنتجات</option>
                    <option value="ready">منتجات جاهزة</option>
                    <option value="services">خدمات</option>
                </select>
                <button class="filter-btn">تصفية</button>
            </section>

            <section class="products-list-container" id="products-list-container">
                <p style="text-align: center; padding: 20px;">جاري تحميل المنتجات...</p>
            </section>
        </main>

        <div id="addProductModal" class="modal-overlay">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h3>إضافة منتج جديد</h3>
                
                <form class="product-form">
                    <div class="form-group">
                        <label for="productName">اسم المنتج:</label>
                        <input type="text" id="productName" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group half-width">
                            <label for="productPrice">السعر (رس):</label>
                            <input type="number" id="productPrice" min="0" step="0.01" required>
                        </div>
                        <div class="form-group half-width">
                            <label for="productStock">الكمية/المخزون:</label>
                            <input type="number" id="productStock" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="productDescription">الوصف:</label>
                        <textarea id="productDescription" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="productImage">صورة المنتج:</label>
                        <input type="file" id="productImage" accept="image/*">
                        <div class="image-upload-area">
                            <p>انقر لرفع الصورة أو اسحبها هنا</p>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeModal()">إلغاء</button>
                        <button type="submit" class="save-btn" id="save-product-btn">حفظ المنتج</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> 

    <script>
        // ⚠️ مفاتيح مشروعك "osama-alqisee"
        const firebaseConfig = {
            apiKey: "AIzaSyBNQ7YzUxzveUorMgHraMii7C5uZ-K8b6s",
            authDomain: "osama-alqisee.firebaseapp.com",
            projectId: "osama-alqisee",
            storageBucket: "osama-alqisee.firebasestorage.app",
            messagingSenderId: "689498064354",
            appId: "1:689498064354:web:956a072dd4e9ee99f2e5bb",
            measurementId: "G-F8GL8K46W5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.analytics();
    </script>

    <script>
        const productsListContainer = document.getElementById('products-list-container');
        const productForm = document.querySelector('.product-form');
        const saveProductBtn = document.getElementById('save-product-btn');

        // وظائف إظهار وإخفاء النافذة المنبثقة
        function openModal() {
            document.getElementById('addProductModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('addProductModal').style.display = 'none';
            document.querySelector('.product-form').reset();
        }

        document.querySelector('.add-product-btn').onclick = openModal;
        
        // ------------------------------------------------------------------
        // * وظيفة بناء بطاقة المنتج (للعرض)
        // ------------------------------------------------------------------

        function buildProductCard(product, productId) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // تحديد حالة المخزون
            let stockStatus = 'متوفر';
            if (product.stock === 0) {
                stockStatus = 'نفد المخزون';
            } else if (product.stock < 10) {
                stockStatus = 'قليل';
            }

            // عرض محتوى بطاقة المنتج
            card.innerHTML = `
                <div class="product-image-placeholder">صورة المنتج</div>
                <div class="product-details">
                    <h4 class="product-name">${product.name}</h4>
                    <p class="product-price">${(product.price || 0).toFixed(2)} رس</p>
                    <div class="product-meta">
                        <span>المخزون: **${product.stock || 0}** حبة</span> | <span>الحالة: **${stockStatus}**</span>
                    </div>
                </div>
                <div class="product-actions">
                    <button class="edit-btn" data-id="${productId}">تعديل</button>
                    <button class="delete-btn" data-id="${productId}">حذف</button>
                </div>
            `;
            return card;
        }

        // ------------------------------------------------------------------
        // * وظيفة جلب وعرض المنتجات من Firebase
        // ------------------------------------------------------------------

        async function fetchAndRenderProducts() {
            productsListContainer.innerHTML = '<p style="text-align: center; padding: 20px;">جاري تحميل المنتجات...</p>';
            
            try {
                // جلب المنتجات مرتبة حسب تاريخ الإنشاء
                const snapshot = await db.collection("products").orderBy("createdAt", "desc").get();
                
                productsListContainer.innerHTML = ''; // مسح رسالة التحميل

                if (snapshot.empty) {
                    productsListContainer.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد منتجات حالياً. ابدأ بإضافة منتج جديد.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const productData = doc.data();
                    const productId = doc.id;
                    
                    const newCard = buildProductCard(productData, productId);
                    productsListContainer.appendChild(newCard);
                });

            } catch (error) {
                console.error("❌ خطأ في جلب المنتجات من Firestore: ", error);
                productsListContainer.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">فشل تحميل المنتجات. (تحقق من مجموعة Products)</p>`;
            }
        }
        
        // ------------------------------------------------------------------
        // * وظيفة حفظ المنتج في Firebase
        // ------------------------------------------------------------------

        async function saveProduct(data) {
            saveProductBtn.disabled = true;
            saveProductBtn.textContent = 'جاري الحفظ...';

            // إضافة تاريخ الإنشاء
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            // إضافة حقول افتراضية يمكن استخدامها لاحقاً
            data.isPublished = true;
            data.rating = 0;

            try {
                await db.collection("products").add(data);
                
                alert(`✅ تم حفظ المنتج "${data.name}" بنجاح!`);
                closeModal();
                await fetchAndRenderProducts(); // إعادة جلب القائمة
                
            } catch (error) {
                console.error("❌ فشل حفظ المنتج في Firestore:", error);
                alert(`❌ فشل حفظ المنتج: ${error.message}`);
            } finally {
                saveProductBtn.disabled = false;
                saveProductBtn.textContent = 'حفظ المنتج';
            }
        }
        
        // ------------------------------------------------------------------
        // * معالجة إرسال النموذج (تحديث للدالة الحقيقية)
        // ------------------------------------------------------------------

        productForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            // جمع البيانات
            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                description: document.getElementById('productDescription').value,
                // يتم تجاهل حقل الصورة مؤقتاً في هذا الكود، لأنه يتطلب Firebase Storage
            };
            
            saveProduct(productData);
        });
        
        // ------------------------------------------------------------------
        // * تشغيل الوظيفة عند تحميل الصفحة
        // ------------------------------------------------------------------
        
        fetchAndRenderProducts();
    </script>
</body>
</html>
